name: CI → Build → Cloud Run

on:
  push:
    branches:
      - main                     # каждый push в main триггерит workflow

# ▸ переменные, которые будут доступны во ВСЕХ job-ах/шагах
env:
  REGION:      ${{ secrets.GCP_REGION }}          # пример: us-central1
  PROJECT_ID:  ${{ secrets.GCP_PROJECT }}         # пример: burnished-yeti-406022
  SERVICE:     web-converter-service              # имя Cloud Run-сервиса
  REPOSITORY:  web-converter-repo                 # Artifact Registry repo (Docker)

jobs:
  build-push-deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    # ---------- аутентификация в Google Cloud ----------
    - name: Auth to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    # ---------- сборка образа и push в Artifact Registry ----------
    - name: Build & push image
      uses: google-github-actions/build-push-action@v1
      with:
        push: true
        tags: |
          ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/web-converter:${{ github.sha }}
          ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/web-converter:latest   # «скользящий» тег

    # ---------- деплой в Cloud Run ----------
    - name: Deploy to Cloud Run
      uses: google-github-actions/deploy-cloudrun@v1
      with:
        service:  ${{ env.SERVICE }}
        region:   ${{ env.REGION }}
        image:    ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/web-converter:latest
        allow_unauthenticated: true
