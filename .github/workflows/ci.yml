name: CI → Build → Cloud Run

on:
  push:
    branches: [main]

env:                       # ← объявляем однажды и пользуемся внизу
  REGION:      ${{ secrets.GCP_REGION }}
  PROJECT_ID:  ${{ secrets.GCP_PROJECT }}
  SERVICE:     web-converter-service
  REPOSITORY:  web-converter-repo        # ваш AR-репозиторий
  IMAGE_PATH:  ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/web-converter

jobs:
  build-push-deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    # ---------- аутентификация в Google Cloud ----------
    - name: Auth to GCP
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    # ---------- сборка образа и пуш в Artifact Registry ----------
    - name: Build & push image
      uses: google-github-actions/build-push-action@v1
      with:
        push: true
        tags: |
          ${{ env.IMAGE_PATH }}:${{ github.sha }}
          ${{ env.IMAGE_PATH }}:latest           # скользящий тег

    # ---------- деплой в Cloud Run ----------
    - name: Deploy to Cloud Run
      uses: google-github-actions/deploy-cloudrun@v1
      with:
        service:  ${{ env.SERVICE }}
        region:   ${{ env.REGION }}
        image:    ${{ env.IMAGE_PATH }}:latest   # всегда разворачиваем :latest
        allow_unauthenticated: true
